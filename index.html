<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earthquake Monitor - Bangkok</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #0d1b2a;
            color: #e0e0e0;
            overflow-x: hidden;
        }
        .container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        h1 {
            font-size: 3.5em;
            margin: 0 0 20px;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.7);
            animation: glow 2s infinite alternate;
        }
        #map {
            width: 100%;
            height: 450px;
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            margin: 20px 0;
            background: #1b263b;
            position: relative;
            z-index: 1;
        }
        .earthquake-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            padding: 20px;
        }
        .earthquake-card {
            background: #1b263b;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #415a77;
            position: relative;
        }
        .earthquake-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
            border-color: #00d4ff;
        }
        .magnitude.low { color: #ff6b6b; }
        .magnitude.medium { color: #ffeb3b; }
        .magnitude.high { color: #d81b60; }
        .seen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background: #ff9500;
            color: #0d1b2a;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .seen-btn:hover {
            background: #e08500;
        }
        .no-data {
            font-size: 1.3em;
            padding: 20px;
            color: #39ff14; /* Vert fluo */
            text-shadow: 0 0 10px rgba(57, 255, 20, 0.8), 0 0 20px rgba(57, 255, 20, 0.6); /* Glow vert fluo */
            background: linear-gradient(90deg, #00d4ff, #87cefa); /* Dégradé bleu clair */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
            animation: calmGlow 6s ease-in-out infinite;
            margin: 10px 0;
        }
        .update-info {
            font-size: 1.1em;
            margin: 15px 0;
            color: #ff9500;
            text-shadow: 0 0 10px rgba(255, 149, 0, 0.7);
            animation: glowOrange 2s infinite alternate;
            position: relative;
            display: inline-block;
        }
        .update-info::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 3px;
            background: #ff9500;
            box-shadow: 0 0 10px rgba(255, 149, 0, 0.7);
            animation: loadingBar 60s linear infinite;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .refresh-btn, .filter-btn, .toggle-alert-btn {
            padding: 12px 30px;
            font-size: 1.2em;
            background: #00d4ff;
            color: #0d1b2a;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        .toggle-alert-btn {
            background: #ff6b6b;
        }
        .toggle-alert-btn.enabled {
            background: #00d4ff;
        }
        .refresh-btn:hover, .filter-btn:hover, .toggle-alert-btn:hover {
            background: #00b8d4;
        }
        .toggle-alert-btn:hover {
            background: #e05a5a;
        }
        .toggle-alert-btn.enabled:hover {
            background: #00b8d4;
        }
        .refresh-btn:active, .filter-btn:active, .toggle-alert-btn:active { transform: scale(0.95); }
        .stats { font-size: 1.1em; margin: 20px 0; color: #a3bffa; }
        #magnitudeChart { max-width: 600px; margin: 20px auto; }
        footer { margin-top: 40px; font-size: 0.95em; color: #778da9; }
        .logo-container {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 100px;
            height: 100px;
            z-index: 2;
        }
        .logo {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            animation: borderGlow 5s linear infinite;
        }
        .orbit {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: orbit 5s linear infinite;
        }
        .orbit::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            width: 10px;
            height: 10px;
            background: #00d4ff;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(0, 212, 255, 1);
            transform: translateX(-50%);
        }
        /* Styles pour le module de flux d'actualités avec carrousel */
        .news-feed {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }
        .news-feed h2 {
            font-size: 1.5em;
            color: #00d4ff;
            margin-bottom: 15px;
        }
        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .tab-btn {
            padding: 10px 20px;
            background: #1b263b;
            color: #e0e0e0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .tab-btn.active {
            background: #00d4ff;
            color: #0d1b2a;
        }
        .tab-btn:hover {
            background: #00b8d4;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .news-carousel {
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        .news-list {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        .news-item {
            flex: 0 0 100%;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.3s ease;
        }
        .news-item:last-child {
            border-bottom: none;
        }
        .news-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .news-item a {
            color: #a3bffa;
            text-decoration: none;
            font-size: 1em;
        }
        .news-item a:hover {
            color: #00d4ff;
            text-decoration: underline;
        }
        .news-item p {
            font-size: 0.9em;
            color: #778da9;
            margin: 5px 0 0;
        }
        .carousel-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            transform: translateY(-50%);
        }
        .carousel-nav button {
            background: rgba(0, 212, 255, 0.5);
            border: none;
            color: #fff;
            font-size: 1.5em;
            padding: 10px;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        .carousel-nav button:hover {
            background: rgba(0, 212, 255, 0.8);
        }
        @keyframes glow {
            from { text-shadow: 0 0 10px rgba(0, 212, 255, 0.7); }
            to { text-shadow: 0 0 20px rgba(0, 212, 255, 1); }
        }
        @keyframes glowOrange {
            from { text-shadow: 0 0 10px rgba(255, 149, 0, 0.7); }
            to { text-shadow: 0 0 20px rgba(255, 149, 0, 1); }
        }
        @keyframes orbit {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes borderGlow {
            0% { box-shadow: 0 0 10px rgba(0, 212, 255, 0.5); }
            25% { box-shadow: 0 0 20px rgba(0, 212, 255, 1); }
            50% { box-shadow: 0 0 10px rgba(0, 212, 255, 0.5); }
            75% { box-shadow: 0 0 20px rgba(0, 212, 255, 1); }
            100% { box-shadow: 0 0 10px rgba(0, 212, 255, 0.5); }
        }
        @keyframes loadingBar {
            0% { width: 0; }
            100% { width: 100%; }
        }
        @keyframes calmGlow {
            0% { box-shadow: 0 0 20px rgba(0, 212, 255, 0.5); }
            50% { box-shadow: 0 0 20px rgba(0, 255, 128, 0.5); }
            100% { box-shadow: 0 0 20px rgba(0, 212, 255, 0.5); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <img src="logo.png" alt="Logo" class="logo">
            <div class="orbit"></div>
        </div>
        <h1>Earthquake Monitor - Bangkok</h1>
        <div id="map"></div>
        <div class="update-info" id="lastUpdate">Last Update: Loading...</div>
        <div class="button-group">
            <button class="refresh-btn" id="refreshButton">Refresh Now</button>
            <button class="filter-btn" onclick="setFilter('1h')">Last Hour</button>
            <button class="filter-btn" onclick="setFilter('24h')">Last 24 Hours</button>
            <button class="filter-btn" onclick="setFilter('all')">All Recent</button>
            <button class="toggle-alert-btn enabled" id="toggleAlertButton" onclick="toggleAlertSound()">Désactiver l'alerte sonore</button>
        </div>
        <div class="no-data" id="noDataMessage" style="display: none;">No recent earthquakes detected within 2000 km of Bangkok.</div>
        <div class="news-feed" id="newsFeed">
            <h2>Latest News</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('bangkok')">Bangkok</button>
                <button class="tab-btn" onclick="showTab('myanmar')">Myanmar</button>
            </div>
            <div id="bangkok" class="tab-content active">
                <div class="news-carousel" id="bangkokNewsCarousel">
                    <div class="news-list" id="bangkokNewsList">
                        <p>Loading news for Bangkok...</p>
                    </div>
                    <div class="carousel-nav">
                        <button onclick="prevNews('bangkok')">❮</button>
                        <button onclick="nextNews('bangkok')">❯</button>
                    </div>
                </div>
            </div>
            <div id="myanmar" class="tab-content">
                <div class="news-carousel" id="myanmarNewsCarousel">
                    <div class="news-list" id="myanmarNewsList">
                        <p>Loading news for Myanmar...</p>
                    </div>
                    <div class="carousel-nav">
                        <button onclick="prevNews('myanmar')">❮</button>
                        <button onclick="nextNews('myanmar')">❯</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="stats" id="stats">Earthquake Stats: Loading...</div>
        <canvas id="magnitudeChart"></canvas>
        <div class="earthquake-list" id="earthquakeList">
            <p class="no-data">Loading data...</p>
        </div>
        <footer>Real-time data - Powered by xAI & USGS</footer>
    </div>
    <audio id="alertSound" src="https://www.soundjay.com/buttons/beep-01a.mp3"></audio>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        const bangkokLat = 13.7563;
        const bangkokLon = 100.5018;
        const maxRadiusKm = 2000;
        let filterPeriod = '1h'; // Par défaut pour les données sismiques : Last Hour
        let newsFilterPeriod = '24h'; // Par défaut pour les actualités : Last 24 Hours
        let chart;
        let alertSoundEnabled = true; // État global de l'alerte sonore
        let seenQuakes = JSON.parse(localStorage.getItem('seenQuakes')) || []; // Liste des tremblements de terre "vus"

        let map;
        try {
            map = L.map('map').setView([bangkokLat, bangkokLon], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        } catch (error) {
            console.error('Map initialization error:', error);
        }

        const ctx = document.getElementById('magnitudeChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Magnitude', data: [], borderColor: '#00d4ff', fill: false }] },
            options: { scales: { y: { beginAtZero: true } } }
        });

        async function fetchEarthquakeData() {
            let url = `https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&latitude=${bangkokLat}&longitude=${bangkokLon}&maxradiuskm=${maxRadiusKm}&minmagnitude=2&limit=10`;
            if (filterPeriod === '1h') url += `&starttime=${new Date(Date.now() - 3600000).toISOString()}`;
            if (filterPeriod === '24h') url += `&starttime=${new Date(Date.now() - 86400000).toISOString()}`;
            try {
                console.log('Fetching data from:', url);
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error: ${response.status} - ${response.statusText}`);
                const data = await response.json();
                console.log('Data received:', data);
                return data.features && data.features.length ? data.features.map(quake => ({
                    id: quake.id, // Ajout de l'ID pour identifier chaque tremblement de terre
                    time: quake.properties.time ? new Date(quake.properties.time).toLocaleString() : 'Unknown time',
                    magnitude: quake.properties.mag !== null ? quake.properties.mag : 'N/A',
                    location: quake.properties.place || 'Unknown',
                    depth: quake.geometry.coordinates[2] !== undefined ? `${quake.geometry.coordinates[2]} km` : 'N/A',
                    lat: quake.geometry.coordinates[1],
                    lon: quake.geometry.coordinates[0]
                })) : [];
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function markAsSeen(quakeId) {
            if (!seenQuakes.includes(quakeId)) {
                seenQuakes.push(quakeId);
                localStorage.setItem('seenQuakes', JSON.stringify(seenQuakes));
            }
        }

        function toggleAlertSound() {
            alertSoundEnabled = !alertSoundEnabled;
            const toggleButton = document.getElementById('toggleAlertButton');
            toggleButton.textContent = alertSoundEnabled ? 'Désactiver l\'alerte sonore' : 'Activer l\'alerte sonore';
            toggleButton.classList.toggle('enabled', alertSoundEnabled);
        }

        function displayEarthquakes(data, error = null) {
            const list = document.getElementById('earthquakeList');
            const noDataMessage = document.getElementById('noDataMessage');
            list.innerHTML = '';
            if (map) map.eachLayer(layer => { if (layer instanceof L.Marker) map.removeLayer(layer); });

            if (error) {
                list.innerHTML = `<p class="no-data">Error loading data: ${error.message}</p>`;
                noDataMessage.style.display = 'none';
            } else if (data.length === 0) {
                list.innerHTML = '';
                noDataMessage.style.display = 'block';
            } else {
                noDataMessage.style.display = 'none';
                data.forEach(quake => {
                    if (map) {
                        const marker = L.marker([quake.lat, quake.lon]).addTo(map);
                        marker.bindPopup(`Magnitude: ${quake.magnitude}<br>${quake.location}<br>${quake.time}`);
                    }
                    const magNum = typeof quake.magnitude === 'number' ? quake.magnitude : 0;
                    const magClass = magNum >= 6 ? 'high' : magNum >= 4 ? 'medium' : 'low';
                    const isSeen = seenQuakes.includes(quake.id);
                    if (magNum >= 5 && !isSeen && alertSoundEnabled) {
                        document.getElementById('alertSound').play();
                    }
                    const card = document.createElement('div');
                    card.className = 'earthquake-card';
                    card.innerHTML = `
                        <button class="seen-btn" onclick="markAsSeen('${quake.id}')">Vu</button>
                        <div class="magnitude ${magClass}">${quake.magnitude}</div>
                        <p><strong>Location:</strong> ${quake.location}</p>
                        <p><strong>Time:</strong> ${quake.time}</p>
                        <p><strong>Depth:</strong> ${quake.depth}</p>
                    `;
                    list.appendChild(card);
                });
            }

            const stats = document.getElementById('stats');
            const total = data.length;
            const validMags = data.filter(q => typeof q.magnitude === 'number');
            const avgMag = validMags.length ? (validMags.reduce((sum, q) => sum + q.magnitude, 0) / validMags.length).toFixed(2) : 'N/A';
            const closest = total ? Math.min(...data.map(q => calculateDistance(bangkokLat, bangkokLon, q.lat, q.lon))).toFixed(2) : 'N/A';
            const risk = total ? (data.some(q => q.magnitude > 6 && calculateDistance(bangkokLat, bangkokLon, q.lat, q.lon) < 500) ? 'High' : data.some(q => q.magnitude > 4) ? 'Moderate' : 'Low') : 'None';
            stats.textContent = `Earthquake Stats: Total: ${total} | Avg Magnitude: ${avgMag} | Closest: ${closest} km | Risk: ${risk}`;

            chart.data.labels = data.map(q => q.time && typeof q.time === 'string' ? q.time.split(',')[1]?.trim() || q.time : 'Unknown');
            chart.data.datasets[0].data = data.map(q => typeof q.magnitude === 'number' ? q.magnitude : 0);
            chart.update();

            updateLastUpdate();
        }

        function updateLastUpdate() {
            document.getElementById('lastUpdate').textContent = `Last Update: ${new Date().toLocaleString()}`;
        }

        async function refreshData() {
            const refreshButton = document.getElementById('refreshButton');
            refreshButton.disabled = true;
            refreshButton.textContent = 'Refreshing...';
            try {
                const data = await fetchEarthquakeData();
                displayEarthquakes(data);
                // Rafraîchir les actualités en fonction du filtre actif
                await refreshNews();
            } catch (error) {
                displayEarthquakes([], error);
            } finally {
                refreshButton.disabled = false;
                refreshButton.textContent = 'Refresh Now';
            }
        }

        function setFilter(period) {
            filterPeriod = period;
            refreshData();
        }

        // Fonction pour récupérer les actualités via GNews API
        async function fetchNews(query, location) {
            const apiKey = 'a87f311a5f7a856185c4133ec952c246'; // Clé API GNews fournie
            let url = `https://gnews.io/api/v4/search?q=${encodeURIComponent(query)}&lang=en&max=5&apikey=${apiKey}`;
            
            // Appliquer le filtre de période pour les actualités
            const now = new Date();
            let fromDate;
            if (newsFilterPeriod === '1h') {
                fromDate = new Date(now.getTime() - 3600000).toISOString().split('.')[0] + 'Z';
            } else if (newsFilterPeriod === '24h') {
                fromDate = new Date(now.getTime() - 86400000).toISOString().split('.')[0] + 'Z';
            } else {
                fromDate = '2025-03-28T00:00:00Z'; // Depuis le 28 mars 2025 pour "All Recent"
            }
            url += `&from=${fromDate}&to=${now.toISOString().split('.')[0] + 'Z'}`;

            try {
                console.log(`Fetching news for ${location} with URL: ${url}`);
                const response = await fetch(url);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error: ${response.status} - ${errorText}`);
                }
                const data = await response.json();
                console.log(`News data for ${location}:`, data);
                return data.articles ? data.articles : [];
            } catch (error) {
                console.error(`News fetch error for ${location}:`, error);
                return [];
            }
        }

        // Gestion du carrousel pour chaque onglet
        const carouselStates = {
            bangkok: { currentIndex: 0, articles: [] },
            myanmar: { currentIndex: 0, articles: [] }
        };

        function prevNews(tabId) {
            const state = carouselStates[tabId];
            if (state.currentIndex > 0) {
                state.currentIndex--;
                updateCarousel(tabId);
            }
        }

        function nextNews(tabId) {
            const state = carouselStates[tabId];
            if (state.currentIndex < state.articles.length - 1) {
                state.currentIndex++;
                updateCarousel(tabId);
            }
        }

        function updateCarousel(tabId) {
            const state = carouselStates[tabId];
            const newsList = document.getElementById(`${tabId}NewsList`);
            newsList.style.transform = `translateX(-${state.currentIndex * 100}%)`;
        }

        // Fonction pour afficher les actualités
        async function displayNews(location, elementId) {
            const newsList = document.getElementById(elementId);
            newsList.innerHTML = `<p>Loading news for ${location}...</p>`;
            const query = `${location} earthquake OR seismic OR disaster`; // Requête élargie pour plus de résultats
            const articles = await fetchNews(query, location);

            // Supprimer les doublons en comparant les URLs
            const uniqueArticles = [];
            const seenUrls = new Set();
            for (const article of articles) {
                if (!seenUrls.has(article.url)) {
                    seenUrls.add(article.url);
                    uniqueArticles.push(article);
                }
            }

            // Mettre à jour l'état du carrousel
            const tabId = elementId === 'bangkokNewsList' ? 'bangkok' : 'myanmar';
            carouselStates[tabId].articles = uniqueArticles;
            carouselStates[tabId].currentIndex = 0;

            newsList.innerHTML = '';
            if (uniqueArticles.length === 0) {
                newsList.innerHTML = `<p>No recent news found for ${location} in the selected time period. Try refreshing or checking the console for errors.</p>`;
            } else {
                uniqueArticles.forEach(article => {
                    const newsItem = document.createElement('div');
                    newsItem.className = 'news-item';
                    newsItem.innerHTML = `
                        <a href="${article.url}" target="_blank">${article.title}</a>
                        <p>${new Date(article.publishedAt).toLocaleString()}</p>
                    `;
                    newsList.appendChild(newsItem);
                });
                updateCarousel(tabId);
            }
        }

        // Fonction pour rafraîchir les actualités
        async function refreshNews() {
            await displayNews('Bangkok', 'bangkokNewsList');
            await displayNews('Myanmar', 'myanmarNewsList');
        }

        // Gestion des onglets
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-btn[onclick="showTab('${tabId}')"]`).classList.add('active');
        }

        // Initialisation
        document.getElementById('refreshButton').addEventListener('click', refreshData);
        fetchEarthquakeData().then(data => displayEarthquakes(data)).catch(err => {
            displayEarthquakes([], err);
        });
        setInterval(refreshData, 60000);

        // Charger les actualités pour Bangkok et Myanmar au démarrage
        refreshNews();
    </script>
</body>
</html>
